## Apply discounts

> Headers

```
Content-type: application/json
```

> Body example

```json
{
    "shop_id":         "...",
    "shop_secret":     "...",
    "order_id":        "...",
    "identifier":      "...",
    "payment_type":    "...",
    "charge_bonuses":  true,
    "cart_items": [
      {"product_id": "...", "price": 1000, "quantity": 4},
      {"product_id": "...", "price": 2000, "quantity": 1}
    ]
}
```

> Request example

```shell
curl --header "Content-Type: application/json" \
  --request POST \
  --data-binary "@data.json" \
  https://<%= config[:api_endpoint] %>/loyalty/checkout/apply
```

```javascript
// S2S only
```
```swift
// S2S only
```
```java
// S2S only
```
```kotlin
// S2S only
```
```jsx
// S2S only
```

> The above command returns JSON structured like this:

```json
{
  "success": true,
  "payload": {
    "order_id": "...",
    "identifier": "...",
    "payment_type": "...",
    "order_total": 6000,
    "order_discount": 1000,
    "order_to_pay": 5000,
    "order_bonuses_to_charge": 500,
    "items": [
      {
        "product_id": "...",
        "quantity": 4,
        "price": 1000,
        "total": 4000,
        "discountable": true,
        "bonusable": true,
        "rewardable": true,
        "paid_with_offers": 0,
        "paid_with_discounts": 500,
        "paid_with_bonuses": 500,
        "bonuses_used": 500,
        "bonuses_used_per_product": 125,
        "total_after_discounts": 3500
      },
      ...
    ]
  }
}
```

### HTTP Request

`POST https://<%= config[:api_endpoint] %>/loyalty/checkout/apply`

When clients proceed to the payment step, execute the this method to charge for bonuses and get the final payment value.

If `charge_bonuses` parameter is missing or `false`, only offers and discounts will be applied. Bonuses will not be calculated in the final order value and charged.

This method requires `order_id` parameter to apply bonuses and save results in our database.

This method actually charges a client for bonuses so it's not safe to execute it several times for the same `order_id` or `identifier`.

If client decided to not pay for the order, use "order status sync" operation to cancel the order and refund bonuses charged in this operation.
