# Loyalty program

Service provides endpoints for loyalty program management.

## Join loyalty program

> Headers

```
Content-type: application/json
```

> Body example

```json
{
    "shop_id": "...",
    "shop_secret": "...",
    "phone": "...",
    "email": "...",
    "first_name": "...",
    "last_name": "...",
    "gender": "...",
    "birthday": "..."
}
```

> Request example

```shell
curl --header "Content-Type: application/json" \
  --request POST \
  --data-binary "@data.json" \
  https://<%= config[:api_endpoint] %>/loyalty/members/join
```

```javascript
// S2S only
```

```swift
// S2S only
```

```java
// S2S only
```

```kotlin
// S2S only
```

```jsx
// S2S only
```

> The above command returns JSON structured like this:

```json
{
  "success": true,
  "payload": {
    "message": "Member is registered successfully",
    "identifier": "..."
  }
}
```

### HTTP Request

`POST https://<%= config[:api_endpoint] %>/loyalty/members/join`

Method to register a user as a member of loyalty program. Server-to-server integration method only.

### Query Parameters

| Parameter   | Required | Description                               |
|-------------|----------|-------------------------------------------|
| shop_id     | true     | Your API key                              |
| shop_secret | true     | Your API secret key                       |
| email       | true     | User's email                              |
| phone*      | true     | User's phone number. Required.            |
| first_name  | optional | Customer's first name                     |
| last_name   | optional | Customer's last name                      |
| gender      | optional | Customer's gender: `m` or `f`             |
| birthday    | optional | Customer's birthday (format: `YYYY-MM-DD` |




## Estimate discounts

> Headers

```
Content-type: application/json
```

> Body example

```json
{
    "shop_id":        "...",
    "shop_secret":    "...",
    "identifier":     "...",
    "charge_bonuses": true,
    "cart_items": [
      {"product_id": "...", "price": 1000, "quantity": 4},
      {"product_id": "...", "price": 2000, "quantity": 1}
    ]
}
```

> Request example

```shell
curl --header "Content-Type: application/json" \
  --request POST \
  --data-binary "@data.json" \
  https://<%= config[:api_endpoint] %>/loyalty/estimate
```

```javascript
// S2S only
```
```swift
// S2S only
```
```java
// S2S only
```
```kotlin
// S2S only
```
```jsx
// S2S only
```

> The above command returns JSON structured like this:

```json
{
  "success": true,
  "payload": {
    "order_id": null,
    "identifier": "...",
    "order_total": 6000,
    "order_discount": 1000,
    "order_to_pay": 5000,
    "order_bonuses_to_charge": 500,
    "items": [
      {
        "product_id": "...",
        "quantity": 4,
        "price": 1000,
        "total": 4000,
        "discountable": true,
        "bonusable": true,
        "paid_with_offers": 0,
        "paid_with_discounts": 500,
        "paid_with_bonuses": 500,
        "bonuses_used": 500,
        "bonuses_used_per_product": 125,
        "total_after_discounts": 3500,
      },
      ...
    ]
  }
}
```

### HTTP Request

`POST https://<%= config[:api_endpoint] %>/loyalty/estimate`

Method estimates discounts and bonuses usage for the shopping cart.

This is the first operation in the checkout process. POS or website sends this request with the client's shopping cart and receives calculated order value with discounts. This operation doesn't charge for bonuses and can be requested several times safely.

If `charge_bonuses` is missing or `false`, only offers and discounts will be applied. Bonuses will not be calculated.

When clients proceed to the payment step, execute the next method `apply` to charge for bonuses and get the final payment value.





## Apply discounts

> Headers

```
Content-type: application/json
```

> Body example

```json
{
    "shop_id":         "...",
    "shop_secret":     "...",
    "order_id":        "...",
    "identifier":      "...",
    "charge_bonuses":  true,
    "cart_items": [
      {"product_id": "...", "price": 1000, "quantity": 4},
      {"product_id": "...", "price": 2000, "quantity": 1}
    ]
}
```

> Request example

```shell
curl --header "Content-Type: application/json" \
  --request POST \
  --data-binary "@data.json" \
  https://<%= config[:api_endpoint] %>/loyalty/estimate
```

```javascript
// S2S only
```
```swift
// S2S only
```
```java
// S2S only
```
```kotlin
// S2S only
```
```jsx
// S2S only
```

> The above command returns JSON structured like this:

```json
{
  "success": true,
  "payload": {
    "order_id": "...",
    "identifier": "...",
    "order_total": 6000,
    "order_discount": 1000,
    "order_to_pay": 5000,
    "order_bonuses_to_charge": 500,
    "items": [
      {
        "product_id": "...",
        "quantity": 4,
        "price": 1000,
        "total": 4000,
        "discountable": true,
        "bonusable": true,
        "paid_with_offers": 0,
        "paid_with_discounts": 500,
        "paid_with_bonuses": 500,
        "bonuses_used": 500,
        "bonuses_used_per_product": 125,
        "total_after_discounts": 3500,
      },
      ...
    ]
  }
}
```

### HTTP Request

`POST https://<%= config[:api_endpoint] %>/loyalty/apply`

When clients proceed to the payment step, execute the this method to charge for bonuses and get the final payment value.

If `charge_bonuses` parameter is missing or `false`, only offers and discounts will be applied. Bonuses will not be calculated in the final order value and charged.

This method requires `order_id` parameter to apply bonuses and save results in our database.

This method actually charges a client for bonuses so it's not safe to execute it several times for the same `order_id` or `identifier`.

If client decided to not pay for the order, use "order status sync" operation to cancel the order and refund bonuses charged in this operation.






## Get balance
> Request example

```shell
curl 'https://<%= config[:api_endpoint] %>/loyalty/basic/balance?shop_id=SHOP_ID&shop_secret=SHOP_SECRET&phone=PHONE&order_total=ORDER_TOTAL'
```

> The above command returns JSON structured like this:

```json
{
    "confirmed": 123,
    "pending": 456,
    "expiring": 789,
    "expire_in": "2022-12-12 23:59:59 UTC",
    "available_in_order": 100, // How many bonuses can be spent in this purchase
    "payable_amount": 50 // How much it will in currency if exchange rate is not 1:1
}
```

Method return current bonuses balance.

### HTTP Request

`GET https://<%= config[:api_endpoint] %>/loyalty/basic/balance`

### Query Parameters

| Parameter   | Required | Description                          |
|-------------|----------|--------------------------------------|
| shop_id     | true     | Your API key                         |
| shop_secret | true     | Your API secret key                  |
| email*      | true     | User's email                         |
| phone*      | true     | User's phone number                  |
| expire_in   | optional | Bonuses expiration date (DD-MM-YYYY) |
| order_total | optional | Order total                          |

<aside class="notice">
At least one of identifiers (marked by *) must present in request: email, phone. It's used to identify user.
</aside>


### API response

| Name                | Type     | Description                            |
|---------------------|----------|----------------------------------------|
| confirmed           | Int      | Available bonuses                      |
| pending             | Int      | Pending bonuses                        |
| expiring            | Int      | Bonuses that will be expired           |
| expire_in           | Datetime | Expiring period                        |
| available_in_order  | Int      | Available bonuses for use in the order |


## Get SMS code

> Request example

```shell
curl 'https://<%= config[:api_endpoint] %>/loyalty/basic/init_bonus_usage?shop_id=SHOP_ID&shop_secret=SHOP_SECRET&phone=PHONE&bonus_points=BONUS_POINTS'
```

> The above command returns JSON structured like this:

```json
{
    "status": "success",
    "sms_code": 123456
}
```

DEPRECATED. Method return SMS code.

### HTTP Request

`GET https://<%= config[:api_endpoint] %>/loyalty/basic/init_bonus_usage`

### Query Parameters

| Parameter     | Required | Description                              |
|---------------|----------|------------------------------------------|
| shop_id       | true     | Your API key                             |
| shop_secret   | true     | Your API secret key                      |
| email*        | true     | User's email                             |
| phone*        | true     | User's phone number                      |
| bonus_points  | true     | Bonuses, which client wants to validate  |

<aside class="notice">
At least one of identifiers (marked by *) must present in request: email, phone. It's used to identify user.
</aside>


### API response

| Name               | Type     | Description                            |
|--------------------|----------|----------------------------------------|
| sms_code           | Int      | SMS code                               |


## Validate SMS code

> Request example

```shell
curl --location --request POST 'https://<%= config[:api_endpoint] %>/loyalty/basic/use_bonus_points?phone=PHONE&shop_id=SHOP_ID&shop_secret=SHOP_SECRET&bonus_points=BONUS_POINTS&confirm_code=true&sms_code=SMS_CODE'
```

> The above command returns JSON structured like this:

```json
{
    "confirmation": "success",
    "confirmed": 123456
}
```

DEPRECATED. Method validate SMS code.

### HTTP Request

`POST https://<%= config[:api_endpoint] %>/loyalty/basic/use_bonus_points`

### Query Parameters

| Parameter    | Required | Description                             |
|--------------|----------|-----------------------------------------|
| shop_id      | true     | Your API key                            |
| shop_secret  | true     | Your API secret key                     |
| email*       | true     | User's email                            |
| phone*       | true     | User's phone number                     |
| bonus_points | true     | Bonuses, which client wants to validate |
| confirm_code | true     | Param for validate                      |
| sms_code     | true     | SMS code                                |

<aside class="notice">
At least one of identifiers (marked by *) must present in request: email, phone. It's used to identify user.
</aside>


### API response

| Name         | Type   | Description       |
|--------------|--------|-------------------|
| confirmation | String | Response message  |
| confirmed    | int    | Validated bonuses |

## Decrease bonuses

> Request example

```shell
curl --location --request POST 'https://<%= config[:api_endpoint] %>/loyalty/basic/use_bonus_points_confirmed?phone=PHONE&shop_id=SHOP_ID&shop_secret=SHOP_SECRET&bonus_points=BONUS_POINTS&sms_code=SMS_CODE'
```

> The above command returns JSON structured like this:

```json
{
    "confirmation": "success",
    "confirmed": 123456
}
```

DEPRECATED. Method decrease bonuses.

### HTTP Request

`POST https://<%= config[:api_endpoint] %>/loyalty/basic/use_bonus_points_confirmed`

### Query Parameters

| Parameter    | Required | Description                             |
|--------------|----------|-----------------------------------------|
| shop_id      | true     | Your API key                            |
| shop_secret  | true     | Your API secret key                     |
| email*       | true     | User's email                            |
| phone*       | true     | User's phone number                     |
| bonus_points | true     | Bonuses, which client wants to validate |
| sms_code     | true     | SMS code                                |

<aside class="notice">
At least one of identifiers (marked by *) must present in request: email, phone. It's used to identify user.
</aside>


### API response

| Name      | Type   | Description       |
|-----------|--------|-------------------|
| status    | String | Response status   |
| confirmed | int    | Validated bonuses |

## Decrease bonuses without SMS code

> Request example

```shell
curl --location --request POST 'https://<%= config[:api_endpoint] %>/loyalty/basic/use_bonus_points?phone=PHONE&shop_id=SHOP_ID&shop_secret=SHOP_SECRET&bonus_points=BONUS_POINTS'
```

> The above command returns JSON structured like this:

```json
{
    "confirmation": "success",
    "confirmed": 123456
}
```

DEPRECATED. Method decrease bonuses without SMS code.

### HTTP Request

`POST https://<%= config[:api_endpoint] %>/loyalty/basic/use_bonus_points`

### Query Parameters

| Parameter    | Required | Description                             |
|--------------|----------|-----------------------------------------|
| shop_id      | true     | Your API key                            |
| shop_secret  | true     | Your API secret key                     |
| email*       | true     | User's email                            |
| phone*       | true     | User's phone number                     |
| bonus_points | true     | Bonuses, which client wants to validate |

<aside class="notice">
At least one of identifiers (marked by *) must present in request: email, phone. It's used to identify user.
</aside>


### API response

| Name      | Type   | Description       |
|-----------|--------|-------------------|
| status    | String | Response status   |
| confirmed | int    | Validated bonuses |


## Add bonuses for event

> Request example

```shell
curl --location --request POST 'https://<%= config[:api_endpoint] %>/loyalty/basic/event_bonus?phone=PHONE&shop_id=SHOP_ID&shop_secret=SHOP_SECRET&event=EVENT&amount=AMOUNT'
```

> The above command returns JSON structured like this:

```json
{
    "status": "success"
}
```

Method increase bonuses. This method is used to increase user bonuses that aren't related to an order. It can be any action, for example, registration in the mobile applications. Bonuses added by this method have activated status and can be used immediately.

### HTTP Request

`POST https://<%= config[:api_endpoint] %>/loyalty/basic/event_bonus`

### Query Parameters

| Parameter    | Required | Description                                                                                                 |
|--------------|----------|-------------------------------------------------------------------------------------------------------------|
| shop_id      | true     | Your API key                                                                                                |
| shop_secret  | true     | Your API secret key                                                                                         |
| email*       | true     | User's email                                                                                                |
| phone*       | true     | User's phone number                                                                                         |
| event        | true     | A unique event code that's used once for a user to award bonuses for an action. For example, "registration".|
| amount       | true     | Bonuses amount                                                                                              |

<aside class="notice">
At least one of identifiers (marked by *) must present in request: email, phone. It's used to identify user.
</aside>

### API response

| Name      | Type   | Description       |
|-----------|--------|-------------------|
| status    | String | Response status   |
