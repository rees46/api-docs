# Работа с подписками и отписками

Новые флаги подписок/отписок хранятся в таблице `client_unsubscribes`. Для каждого клиента существует виртуальная двухмерная матрица флагов, состоящая из `channel` (канал отправки) и `message_type` (тип сообщения).

**Каналы отправки:**

* Email
* Телефон
* Веб пуш
* Мобильный пуш
* Телеграм

**Типы сообщений:**

* Массовые рассылки (Bulk)
* Цепочки (Chain)
* Транзакционные (Transactional)

Пример: клиент с указанными Email, Phone и Telegram. Его подписки можно представить в виде таблицы:

|               | Email | Phone | WebPush | MobilePush | Telegram |
| ------------- | ----- | ----- | ------- | ---------- | -------- |
| Bulk          | ✅     | ❌     |         |            | ❌        |
| Chain         | ❌     | ✅     |         |            | ✅        |
| Transactional | ✅     | ✅     |         |            | ✅        |

В таблице БД будут следующие записи:

```text
shop_id | channel_type | channel_id     | message_type
--------|--------------|----------------|--------------
1       | email        | test@test.com  | chain
1       | phone        | 7912345678     | bulk
1       | telegram     | 1234567890     | bulk
```

Хранятся только отписки — то есть записи в таблице обозначают отключённые каналы и типы сообщений.

### Проверка подписки клиента на канал

**Ruby:**

```ruby
client.subscribed?(ClientUnsubscribe::CHANNEL_EMAIL, ClientUnsubscribe::TYPE_CHAIN)
```

**SQL:**

```sql
SELECT 1 FROM client_unsubscribes 
WHERE shop_id = 1 
  AND channel_type = 'email' 
  AND channel_id = 'test@test.com' 
  AND message_type = 'chain' 
LIMIT 1
```

### Получить список клиентов, подписанных на канал email в массовых рассылках

**Ruby:**

```ruby
shop.clients.joins("LEFT JOIN client_unsubscribes \
  ON client_unsubscribes.shop_id = clients.shop_id \
  AND client_unsubscribes.channel_type = '\#{ClientUnsubscribe::CHANNEL_EMAIL}' \
  AND client_unsubscribes.channel_id = clients.\#{ClientUnsubscribe::CHANNEL_ID[ClientUnsubscribe::CHANNEL_EMAIL]}")
.where(client_unsubscribes: {message_type: nil})
```

**SQL:**

```sql
SELECT clients.* FROM clients
LEFT JOIN client_unsubscribes 
  ON client_unsubscribes.shop_id = clients.shop_id 
  AND client_unsubscribes.channel_type = 'email' 
  AND client_unsubscribes.channel_id = clients.email 
WHERE clients.shop_id = 1 
  AND client_unsubscribes.message_type IS NULL
```

⚠️ **Важно:** не хардкодьте значения `channel_type` и `message_type`. Используйте соответствующие константы.

⚠️ **Важно:** при поиске по `client_unsubscribes` обязательно фильтровать по `shop_id`, `channel_type`, `channel_id`.

❗ **Изменения данных** в `client_unsubscribes` допускаются **только в API-проекте** и **только через статичные методы класса `ClientUnsubscribe`**.
